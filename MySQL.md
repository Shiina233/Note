看的是《MySQL技术内幕    InnoDB存储引擎》，第一次笔记给整没了，当个教训了。

------

# 第一章

- MySQL是单进程多线程的
- InnoDB支持事务，支持行锁，外键。默认读取不锁。事务默认可重复读。
- MyISAM不支持事务。采用表锁，支持全文索引。缓冲池只缓存索引文件。

# 第二章-InnoDB

## 内存

###     缓冲池

- InnoDB基于磁盘存储，数据按页管理
- 使用缓冲池来提高数据库性能，读取页时，先查看缓冲池有没有，如果有的话就读取，要读取的在缓冲池中叫命中。如果缓冲池没有，从磁盘读取页，再将页存放在缓冲池。修改页时，先修改缓冲池里的，然后按照一定频率刷新回磁盘，此时缓冲池中已经改变了的页就是脏页。每个页是16KB，但是可以压缩。
- 对于InnoDB，缓存池中有数据页，索引页，插入缓冲和一些其他的，这和MyISAM不同，后者只缓存索引文件。

- 缓冲池通过LRU算法管理页，也就是最频繁使用的在前端，最少用的在后端。和传统的LRU不一样的是，新读取的页并不会放在最前端，而是放在大概5/8的位置

## Checkpoint

- 脏页就是缓存数据和磁盘不一样的页，这就引出了问题，什么时候将脏页刷新回磁盘？答案是每隔一段时间，每次都刷太废资源了。
- 那缓存里的还没刷新宕机了岂不是会丢失？数据库系统一般会采用Write Ahead Log，也就是写前会写重做日志，然后再修改页。
- Checkpoint有什么用呢？第一，缩短了数据库的恢复时间，只需要对 Checkpoint后的重做日志进行恢复，之前的已经确保刷回磁盘了。第二，缓冲池不够用时，刷新回去。第三，重做日志不可用时，刷新回去。

## Master Thread工作方式

- 不太感兴趣，有空再看

## InnoDB的关键特性

### 插入缓冲

看不太懂

### 两次写

- 每个页占16KB，如果写了一半意外中断，数据可能丢失。这就是部分写失效。上面的重做日志是不能用于这种场景的，重做日志记录的是对页的物理操作(物理操作为什么能还原之前缓存丢失的页的？没看懂)。
- 两次写就是在刷新脏页时会先复制一份在内存中，然后又分两次把复制份的写进磁盘的共享表空间，最后再写进表文件(每个表一个文件，除非分区)。

### 自适应哈希索引

- 其实这个就是前面说的哈希索引，这种索引速度快，因为是哈希表，查找的时间复杂度为O(1)。InnoDB会自动根据热点数据来建立，人无法干涉，所以叫自适应。

### AIO

- 异步IO，很普遍的应用，同时执行多个IO，然后等它们所有完成再返回，而不是一个一个执行，后者效率低。

# 第四章

## 约束

- 什么是约束：约束是用来保证数据完整性的一种途径，约束通过限制列中字段的值使其合乎需求，比如不准为空。
- 约束的种类：InnoDB有主键，唯一键，外键，Default，NOT NULL。创建表时，将指定列为主键或唯一键时会自动创建约束。触发器是在插入，更新，删除之前或之后会自动调用的语句。可以通过创建自定义的触发器来实现约束。外键即和其他的表的键建立关联，以保证数据的参照完整性。例如表A删除一行后，表B也要做一定的操作，比如把相关的行删除等，这种情况就可以用外键。Default(啊这，书上没说，有空查下)。

## 视图

- 视图就是基于查询语句建立的一个虚表，它只在逻辑上存在，物理上不存在。
- 它可以被用来作作为基表的一部分的抽象，面向视图的程序不需要关注也不能关注基表，如果像把基表的一部分提供给别人就可以用视图，它基于查询来定义。
- 物化视图，即视图不是虚表，而是确实存储在物理设备上，MySQL不支持，Oracle支持。

## 分区

